# Dart WZ-S-K 甲醛传感器模拟器

这是一个用于测试ESP32主程序的Dart WZ-S-K甲醛传感器模拟器，完全按照协议文档实现。

## 功能特性

- ✅ 默认主动上传模式启动
- ✅ 支持问答模式（通过串口命令切换）
- ✅ 实时浓度模拟（20-100 ppb范围内随机变化）
- ✅ 完整的协议实现（校验和计算、数据包格式）
- ✅ 运行时模式切换（无需重启）
- ✅ 详细的调试信息输出
- ✅ 多线程处理，支持并发通信

## 安装依赖

```bash
pip install -r requirements.txt
```

## 使用方法

### 基本用法

```bash
# 启动模拟器（默认主动上传模式）
python dart_simulator.py COM3

# 自定义波特率
python dart_simulator.py COM3 --baudrate 115200
```

### 参数说明

- `port`: 串口端口（必需）
  - Windows: `COM1`, `COM2`, `COM3` 等
  - Linux: `/dev/ttyUSB0`, `/dev/ttyACM0` 等
  - macOS: `/dev/tty.usbserial-*` 等

- `--baudrate, -b`: 波特率（默认: 9600）

### 使用示例

```bash
# 1. 启动模拟器（默认主动上传模式）
python dart_simulator.py COM3

# 2. 使用虚拟串口进行测试
# 首先创建虚拟串口对（需要额外工具如com0com）
python dart_simulator.py COM3

# 3. 通过串口命令切换工作模式
# 切换到问答模式: FF 01 78 41 00 00 00 00 46
# 切换到主动上传: FF 01 78 40 00 00 00 00 47
```

## 协议实现

### 主动上传数据包格式

```
| 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 |
|---|---|---|---|---|---|---|---|---|
|起始位|气体名称|单位|小数位数|气体浓度高位|气体浓度低位|满量程高位|满量程低位|校验值|
| 0xFF | 0x17 | 0x04 | 0x00 | 0x00 | 0x25 | 0x07 | 0xD0 | 0x25 |
```

### 问答模式响应格式

```
| 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 |
|---|---|---|---|---|---|---|---|---|
|起始位|命令|气体浓度高位(ug/m3)|气体浓度低位(ug/m3)|保留|保留|气体浓度高位(ppb)|气体浓度低位(ppb)|校验值|
| 0xFF | 0x86 | 0x00 | 0x2A | 0x00 | 0x00 | 0x00 | 0x20 | 0x30 |
```

### 模式切换命令

- 切换到问答模式: `FF 01 78 41 00 00 00 00 46`
- 切换到主动上传: `FF 01 78 40 00 00 00 00 47`

### 读取浓度命令

- 请求: `FF 01 86 00 00 00 00 00 79`

## 调试信息

模拟器会输出详细的调试信息，包括：

- 🎯 初始化信息
- 📤 发送的数据包
- 📥 接收的数据包
- 🔄 模式切换
- 🌡️ 浓度变化
- ❌ 错误信息

## 测试主程序

1. 启动模拟器：
   ```bash
   python dart_simulator.py COM3
   ```

2. 在主程序中配置相同的串口参数：
   - 波特率: 9600
   - 数据位: 8
   - 停止位: 1
   - 校验位: 无

3. 观察模拟器输出，验证数据包格式和通信是否正常

4. 通过串口命令切换工作模式进行测试：
   - 发送 `FF 01 78 41 00 00 00 00 46` 切换到问答模式
   - 发送 `FF 01 78 40 00 00 00 00 47` 切换回主动上传模式

## 运行测试

### 功能测试
```bash
# 使用默认配置运行所有测试
python test_simulator.py

# 指定串口端口
python test_simulator.py --port COM3

# 指定串口和波特率
python test_simulator.py --port COM3 --baudrate 115200
```

### 配置测试
```bash
# 测试串口配置是否正确应用
python test_config.py --port COM3 --baudrate 9600
```

## 使用客户端

### 启动客户端
```bash
# 连接到模拟器
python dart_client.py COM3

# 指定波特率
python dart_client.py COM3 --baudrate 115200
```

### 客户端命令
启动客户端后，可以使用以下交互命令：

- `qa` - 切换到问答模式（自动每5秒请求数据）
- `active` - 切换到主动上传模式  
- `read` - 手动读取浓度数据（问答模式）
- `stats` - 显示统计信息
- `quit` - 退出程序

### 使用示例

1. **启动模拟器**：
   ```bash
   python dart_simulator.py COM3
   ```

2. **启动客户端**：
   ```bash
   python dart_client.py COM3
   ```

3. **交互操作**：
   ```
   请输入命令: qa
   ✅ 已切换到问答模式
   🔄 自动请求已启动（每5秒）
   
   # 自动每5秒请求并显示数据
   🔄 自动请求浓度数据: FF 01 86 00 00 00 00 00 79
   📥 自动响应: FF 86 00 1E 00 00 00 19 43
   📊 问答响应数据:
      浓度: 25 ppb (30 ug/m3)
      时间戳: 14:30:25
   
   请输入命令: read
   📤 发送读取浓度命令: FF 01 86 00 00 00 00 00 79
   📥 收到响应: FF 86 00 1E 00 00 00 19 43
   📊 问答响应数据:
      浓度: 25 ppb (30 ug/m3)
      时间戳: 14:30:30
   
   请输入命令: active
   ✅ 已切换到主动上传模式
   ⏹️  自动请求已停止
   # 自动接收模拟器发送的数据
   
   请输入命令: stats
   📈 统计信息:
      接收数据包: 15
      错误数据包: 0
      当前模式: active
   ```

## 故障排除

### 串口无法打开
- 检查串口是否被其他程序占用
- 确认串口名称是否正确
- 检查串口驱动是否安装

### 数据包校验错误
- 检查波特率设置是否一致
- 确认数据位、停止位、校验位设置
- 检查数据包格式是否符合协议

### 模式切换不生效
- 确认发送的命令格式正确
- 检查校验和计算是否正确
- 观察模拟器输出确认命令是否被正确解析

## 注意事项

1. 模拟器使用多线程，确保主程序能够正确处理并发数据
2. 浓度值在20-100 ppb范围内随机变化，模拟真实环境
3. 校验和计算严格按照协议文档实现
4. 支持实时模式切换，无需重启模拟器
5. 按 Ctrl+C 可以安全停止模拟器

## 开发说明

模拟器采用面向对象设计，主要类：

- `DartSensorSimulator`: 主模拟器类
- 支持扩展更多传感器类型
- 易于添加新的协议命令
- 线程安全的串口通信

## 许可证

本项目遵循与主项目相同的许可证。
